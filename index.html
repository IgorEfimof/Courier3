<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon195.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="COUR3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Калькулятор заработка курьера</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --text-color: #333;
            --bg-color: #f5f7fa;
            --card-bg: #ffffff;
            --input-bg: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --border-color: #ddd;
            --result-title-color: #2c3e50;
            --result-value-color: #27ae60;
            --summary-bg: #e8f4fc;
            --summary-title-color: #2980b9;
            --warning-color: #e74c3c;
            --highlight-color: #f39c12;
            --keyboard-bg: #2c3e50;
            --key-color: #ecf0f1;
            --key-bg: #3498db;
            --key-active-bg: #2980b9;
            --section-bg: #f8f9fa;
        }

        .dark-theme {
            --primary-color: #2980b9;
            --secondary-color: #1a252f;
            --text-color: #ecf0f1;
            --bg-color: #1a252f;
            --card-bg: #2c3e50;
            --input-bg: #34495e;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --border-color: #4a6572;
            --result-title-color: #ecf0f1;
            --result-value-color: #2ecc71;
            --summary-bg: #34495e;
            --summary-title-color: #3498db;
            --warning-color: #e74c3c;
            --highlight-color: #f39c12;
            --keyboard-bg: #1a252f;
            --key-color: #ecf0f1;
            --key-bg: #2980b9;
            --key-active-bg: #3498db;
            --section-bg: #2c3e50;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        input, select {
            -webkit-user-select: text;
            user-select: text;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            padding: 10px;
            min-height: 100vh;
            position: relative;
            padding-bottom: 70px;
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 0 10px var(--shadow-color);
            overflow: hidden;
        }

        header {
            background: var(--secondary-color);
            color: white;
            padding: 12px 15px;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-content {
            flex: 1;
            text-align: center;
        }

        h1 {
            font-size: 1.4rem;
            margin-bottom: 4px;
            color: white;
        }

        .description {
            font-size: 0.85rem;
            opacity: 0.9;
            color: white;
        }

        .theme-toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
            background-color: #ccc;
            border-radius: 30px;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
        }

        .theme-toggle.active {
            background-color: #3498db;
        }

        .theme-toggle-handle {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 26px;
            height: 26px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .theme-toggle.active .theme-toggle-handle {
            transform: translateX(30px);
        }

        .theme-toggle-icon {
            font-size: 12px;
            color: #f39c12;
        }

        .theme-toggle-text {
            margin-left: 8px;
            font-size: 0.85rem;
            color: white;
            white-space: nowrap;
        }

        .content {
            display: flex;
            flex-wrap: wrap;
            padding: 12px;
        }

        .input-section, .results-section {
            flex: 1;
            min-width: 300px;
            padding: 12px;
        }

        .input-section {
            background: var(--card-bg);
            border-radius: 6px;
            margin-right: 12px;
        }

        .section-title {
            color: var(--primary-color);
            margin-bottom: 12px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border-color);
            font-size: 1.1rem;
        }

        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .form-group {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            background-color: var(--input-bg);
            color: var(--text-color);
            caret-color: transparent;
        }

        .time-inputs {
            display: flex;
            gap: 10px;
        }

        .time-input {
            flex: 1;
        }

        .custom-keyboard {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--keyboard-bg);
            padding: 10px;
            display: none;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            touch-action: manipulation;
        }

        .keyboard-visible {
            display: block;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            margin-bottom: 8px;
        }

        .keyboard-key {
            width: 60px;
            height: 50px;
            margin: 0 5px;
            background: var(--key-bg);
            color: var(--key-color);
            border: none;
            border-radius: 5px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }

        .keyboard-key:active {
            background: var(--key-active-bg);
        }

        .key-wide {
            width: 130px;
        }

        .key-actions {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .key-action {
            padding: 10px 20px;
            margin: 0 5px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-top: 8px;
            transition: background 0.3s;
            touch-action: manipulation;
        }

        button:hover {
            background: var(--secondary-color);
        }

        .compact-results {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .compact-result {
            flex: 1;
            min-width: 120px;
            background: var(--card-bg);
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 1px 3px var(--shadow-color);
            text-align: center;
        }

        .compact-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--result-title-color);
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .compact-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--result-value-color);
            white-space: nowrap;
        }

        .compact-summary {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .compact-summary-item {
            flex: 1;
            background: var(--summary-bg);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .summary-title {
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--summary-title-color);
            font-size: 0.9rem;
        }

        .summary-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--result-value-color);
        }

        .average-value {
            color: var(--highlight-color);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .info-text {
            font-size: 0.8rem;
            color: var(--primary-color);
            margin-top: 4px;
            text-align: center;
        }

        .section {
            background: var(--section-bg);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .today-summary {
            background: var(--summary-bg);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .today-title {
            font-weight: 700;
            color: var(--summary-title-color);
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 10px;
        }

        .today-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--result-value-color);
            text-align: center;
        }

        .today-details {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .history-section {
            margin-top: 20px;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .history-date {
            font-weight: 600;
        }

        .history-amount {
            color: var(--result-value-color);
            font-weight: 600;
        }

        @media (max-width: 768px) {
            body {
                padding: 8px;
                padding-bottom: 70px;
            }
            
            header {
                padding: 10px 12px;
                flex-direction: column;
                text-align: center;
            }
            
            .header-content {
                margin-bottom: 10px;
            }
            
            h1 {
                font-size: 1.2rem;
            }
            
            .content {
                flex-direction: column;
                padding: 10px;
            }
            
            .input-section {
                margin-right: 0;
                margin-bottom: 12px;
            }
            
            .input-section, .results-section {
                padding: 10px;
            }
            
            .section-title {
                font-size: 1rem;
            }
            
            .compact-results, .compact-summary {
                flex-direction: row;
                gap: 8px;
            }
            
            .compact-result, .compact-summary-item {
                min-width: calc(50% - 10px);
            }
            
            input, select, button {
                padding: 8px;
                font-size: 16px;
            }
            
            .compact-value, .summary-value {
                font-size: 0.95rem;
            }

            .keyboard-key {
                width: 50px;
                height: 45px;
                font-size: 18px;
            }

            .key-wide {
                width: 110px;
            }
            
            .theme-toggle {
                width: 55px;
                height: 28px;
            }
            
            .theme-toggle-handle {
                width: 24px;
                height: 24px;
            }
            
            .theme-toggle.active .theme-toggle-handle {
                transform: translateX(27px);
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.1rem;
            }
            
            .description {
                font-size: 0.8rem;
            }
            
            .section-title {
                font-size: 0.95rem;
            }
            
            label, button {
                font-size: 14px;
            }
            
            input, select {
                font-size: 16px;
            }
            
            .compact-title {
                font-size: 0.82rem;
            }
            
            .compact-value, .summary-value {
                font-size: 0.9rem;
            }
            
            .info-text {
                font-size: 0.78rem;
            }
            
            .theme-toggle-text {
                font-size: 0.8rem;
            }

            .keyboard-key {
                width: 45px;
                height: 40px;
                font-size: 16px;
                margin: 0 3px;
            }

            .key-wide {
                width: 95px;
            }
        }

        @media (max-width: 360px) {
            .input-section, .results-section {
                padding: 8px;
            }
            
            .form-row {
                margin-bottom: 6px;
            }
            
            input, select {
                padding: 8px;
            }
            
            .compact-result, .compact-summary-item {
                padding: 8px;
                min-width: calc(50% - 8px);
            }

            .keyboard-key {
                width: 40px;
                height: 35px;
                font-size: 14px;
            }

            .key-wide {
                width: 85px;
            }
            
            .theme-toggle {
                width: 50px;
                height: 25px;
            }
            
            .theme-toggle-handle {
                width: 21px;
                height: 21px;
                top: 2px;
                left: 2px;
            }
            
            .theme-toggle.active .theme-toggle-handle {
                transform: translateX(23px);
            }
            
            .theme-toggle-icon {
                font-size: 10px;
            }
        }
    </style>
</head>
<body class="light-theme">
    <div class="container">
        <header>
            <div class="header-content">
                <h1>Калькулятор заработка курьера</h1>
                <p class="description">Расчет доходов с учетом расходов</p>
            </div>
            <div class="theme-toggle-container">
                <div class="theme-toggle" id="theme-toggle">
                    <div class="theme-toggle-handle">
                        <i class="fas fa-sun theme-toggle-icon"></i>
                    </div>
                </div>
                <span class="theme-toggle-text">Тёмная тема</span>
            </div>
        </header>
        
        <div class="content">
            <div class="input-section">
                <h2 class="section-title">Рабочий день</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="start-time">Начало работы</label>
                        <input type="time" id="start-time" value="09:00">
                    </div>
                    
                    <div class="form-group">
                        <label for="end-time">Конец работы</label>
                        <input type="time" id="end-time" value="18:00">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="orders-count">Количество заказов</label>
                        <input type="text" id="orders-count" inputmode="numeric" value="21">
                    </div>
                    
                    <div class="form-group">
                        <label for="earned-amount">Заработанная сумма (руб.)</label>
                        <input type="text" id="earned-amount" inputmode="decimal" value="3519,53">
                    </div>
                </div>
                
                <div class="section">
                    <h2 class="section-title">Расходы</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fuel-per-day">Бензин (л/день)</label>
                            <input type="text" id="fuel-per-day" inputmode="decimal" value="5">
                        </div>
                        
                        <div class="form-group">
                            <label for="fuel-price">Цена бензина (руб.)</label>
                            <input type="text" id="fuel-price" inputmode="decimal" value="50">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="other-costs">Другие расходы (руб./день)</label>
                        <input type="text" id="other-costs" inputmode="decimal" value="200">
                    </div>
                </div>
                
                <div class="section">
                    <h2 class="section-title">График работы</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="work-days-week">Дней в неделю</label>
                            <input type="text" id="work-days-week" inputmode="numeric" value="6">
                        </div>
                        
                        <div class="form-group">
                            <label for="work-days-month">Дней в месяц</label>
                            <input type="text" id="work-days-month" inputmode="numeric" value="24">
                        </div>
                    </div>
                </div>
                
                <button id="save-day-btn">Сохранить день</button>
                <button id="reset-btn" style="background-color: var(--warning-color);">Сбросить настройки</button>
            </div>
            
            <div class="results-section">
                <div class="today-summary">
                    <div class="today-title">Сегодня</div>
                    <div class="today-amount" id="today-amount">3519,53 ₽</div>
                    <div class="today-details">
                        <span id="work-time">09:00 - 18:00</span>
                        <span id="orders-count-display">21 заказ</span>
                    </div>
                </div>
                
                <h2 class="section-title">Результаты за день</h2>
                
                <div class="compact-results">
                    <div class="compact-result">
                        <div class="compact-title">Заказов</div>
                        <div class="compact-value" id="daily-orders">21,00</div>
                    </div>
                    
                    <div class="compact-result">
                        <div class="compact-title">Доход</div>
                        <div class="compact-value" id="daily-income">3519,53 руб.</div>
                    </div>
                    
                    <div class="compact-result">
                        <div class="compact-title">Расходы</div>
                        <div class="compact-value" id="daily-costs">450,00 руб.</div>
                    </div>
                    
                    <div class="compact-result">
                        <div class="compact-title">Чистый доход</div>
                        <div class="compact-value" id="daily-profit">3069,53 руб.</div>
                    </div>
                </div>
                
                <h2 class="section-title">Итоговый заработок</h2>
                
                <div class="compact-summary">
                    <div class="compact-summary-item">
                        <div class="summary-title">В неделю</div>
                        <div class="summary-value" id="weekly-profit">18417,18 руб.</div>
                    </div>
                    
                    <div class="compact-summary-item">
                        <div class="summary-title">В месяц</div>
                        <div class="summary-value" id="monthly-profit">73668,72 руб.</div>
                    </div>
                </div>
                
                <div class="history-section">
                    <h2 class="section-title">История дней</h2>
                    <div class="history-list" id="history-list">
                        <!-- История будет добавляться динамически -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Кастомная клавиатура -->
    <div class="custom-keyboard" id="custom-keyboard">
        <div class="keyboard-row">
            <button class="keyboard-key" data-value="7">7</button>
            <button class="keyboard-key" data-value="8">8</button>
            <button class="keyboard-key" data-value="9">9</button>
            <button class="keyboard-key" data-action="backspace"><i class="fas fa-backspace"></i></button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-key" data-value="4">4</button>
            <button class="keyboard-key" data-value="5">5</button>
            <button class="keyboard-key" data-value="6">6</button>
            <button class="keyboard-key" data-action="clear">C</button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-key" data-value="1">1</button>
            <button class="keyboard-key" data-value="2">2</button>
            <button class="keyboard-key" data-value="3">3</button>
            <button class="keyboard-key" data-value=",">,</button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-key key-wide" data-value="0">0</button>
            <button class="keyboard-key key-wide" data-action="hide">Готово</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Элементы DOM
            const resetBtn = document.getElementById('reset-btn');
            const saveDayBtn = document.getElementById('save-day-btn');
            const themeToggle = document.getElementById('theme-toggle');
            const customKeyboard = document.getElementById('custom-keyboard');
            
            // Параметры рабочего дня
            const startTimeInput = document.getElementById('start-time');
            const endTimeInput = document.getElementById('end-time');
            const ordersCountInput = document.getElementById('orders-count');
            const earnedAmountInput = document.getElementById('earned-amount');
            
            // Расходы
            const fuelPerDayInput = document.getElementById('fuel-per-day');
            const fuelPriceInput = document.getElementById('fuel-price');
            const otherCostsInput = document.getElementById('other-costs');
            
            // График работы
            const workDaysWeekInput = document.getElementById('work-days-week');
            const workDaysMonthInput = document.getElementById('work-days-month');
            
            // Результаты
            const todayAmountElement = document.getElementById('today-amount');
            const workTimeElement = document.getElementById('work-time');
            const ordersCountDisplayElement = document.getElementById('orders-count-display');
            const dailyOrdersElement = document.getElementById('daily-orders');
            const dailyIncomeElement = document.getElementById('daily-income');
            const dailyCostsElement = document.getElementById('daily-costs');
            const dailyProfitElement = document.getElementById('daily-profit');
            const weeklyProfitElement = document.getElementById('weekly-profit');
            const monthlyProfitElement = document.getElementById('monthly-profit');
            const historyListElement = document.getElementById('history-list');
            
            // Текущее активное поле ввода
            let activeInput = null;
            
            // Функция для замены точки на запятую в числах
            function formatNumberWithComma(number) {
                return number.toString().replace('.', ',');
            }
            
            // Функция для замены запятой на точку в числах
            function parseNumberWithComma(value) {
                if (typeof value === 'string') {
                    return parseFloat(value.replace(',', '.'));
                }
                return value;
            }
            
            // Сохранение данных в localStorage
            function saveData() {
                const data = {
                    startTime: startTimeInput.value,
                    endTime: endTimeInput.value,
                    ordersCount: ordersCountInput.value,
                    earnedAmount: earnedAmountInput.value,
                    fuelPerDay: fuelPerDayInput.value,
                    fuelPrice: fuelPriceInput.value,
                    otherCosts: otherCostsInput.value,
                    workDaysWeek: workDaysWeekInput.value,
                    workDaysMonth: workDaysMonthInput.value
                };
                
                localStorage.setItem('courierCalculatorData', JSON.stringify(data));
            }
            
            // Загрузка данных из localStorage
            function loadData() {
                const savedData = localStorage.getItem('courierCalculatorData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    startTimeInput.value = data.startTime || '09:00';
                    endTimeInput.value = data.endTime || '18:00';
                    ordersCountInput.value = data.ordersCount || '21';
                    earnedAmountInput.value = data.earnedAmount || '3519,53';
                    fuelPerDayInput.value = data.fuelPerDay || '5';
                    fuelPriceInput.value = data.fuelPrice || '50';
                    otherCostsInput.value = data.otherCosts || '200';
                    workDaysWeekInput.value = data.workDaysWeek || '6';
                    workDaysMonthInput.value = data.workDaysMonth || '24';
                    
                    calculate();
                }
            }
            
            // Загрузка истории из localStorage
            function loadHistory() {
                const savedHistory = localStorage.getItem('courierHistory');
                if (savedHistory) {
                    const history = JSON.parse(savedHistory);
                    updateHistoryList(history);
                }
            }
            
            // Обновление списка истории
            function updateHistoryList(history) {
                historyListElement.innerHTML = '';
                
                history.slice().reverse().forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    
                    const dateElement = document.createElement('span');
                    dateElement.className = 'history-date';
                    dateElement.textContent = item.date;
                    
                    const amountElement = document.createElement('span');
                    amountElement.className = 'history-amount';
                    amountElement.textContent = item.amount + ' руб.';
                    
                    historyItem.appendChild(dateElement);
                    historyItem.appendChild(amountElement);
                    historyListElement.appendChild(historyItem);
                });
            }
            
            // Сохранение дня в историю
            function saveDay() {
                const date = new Date().toLocaleDateString('ru-RU');
                const amount = parseNumberWithComma(earnedAmountInput.value);
                
                let history = [];
                const savedHistory = localStorage.getItem('courierHistory');
                if (savedHistory) {
                    history = JSON.parse(savedHistory);
                }
                
                // Проверяем, есть ли уже запись за сегодня
                const todayIndex = history.findIndex(item => item.date === date);
                if (todayIndex !== -1) {
                    history[todayIndex].amount = amount;
                } else {
                    history.push({ date, amount });
                }
                
                localStorage.setItem('courierHistory', JSON.stringify(history));
                updateHistoryList(history);
                
                alert('Данные за день сохранены!');
            }
            
            // Сброс данных к значениям по умолчанию
            function resetData() {
                if (confirm('Вы уверены, что хотите сбросить все настройки к значениям по умолчанию?')) {
                    startTimeInput.value = '09:00';
                    endTimeInput.value = '18:00';
                    ordersCountInput.value = '21';
                    earnedAmountInput.value = '3519,53';
                    fuelPerDayInput.value = '5';
                    fuelPriceInput.value = '50';
                    otherCostsInput.value = '200';
                    workDaysWeekInput.value = '6';
                    workDaysMonthInput.value = '24';
                    
                    localStorage.removeItem('courierCalculatorData');
                    calculate();
                }
            }
            
            // Предотвращение масштабирования при двойном тапе
            document.addEventListener('dblclick', function(e) {
                e.preventDefault();
            });
            
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(e) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, { passive: false });

            // Функция расчета
            function calculate() {
                // Получаем значения из полей ввода
                const startTime = startTimeInput.value;
                const endTime = endTimeInput.value;
                const ordersCount = parseNumberWithComma(ordersCountInput.value) || 0;
                const earnedAmount = parseNumberWithComma(earnedAmountInput.value) || 0;
                
                const fuelPerDay = parseNumberWithComma(fuelPerDayInput.value) || 0;
                const fuelPrice = parseNumberWithComma(fuelPriceInput.value) || 0;
                const otherCosts = parseNumberWithComma(otherCostsInput.value) || 0;
                
                const workDaysWeek = parseNumberWithComma(workDaysWeekInput.value) || 0;
                const workDaysMonth = parseNumberWithComma(workDaysMonthInput.value) || 0;
                
                // Рассчитываем продолжительность рабочего дня
                const start = new Date(`2000-01-01T${startTime}`);
                const end = new Date(`2000-01-01T${endTime}`);
                let diffHours = (end - start) / (1000 * 60 * 60);
                if (diffHours < 0) {
                    diffHours += 24; // Если работа переходит через полночь
                }
                
                // Рассчитываем расходы
                const dailyFuelCost = fuelPerDay * fuelPrice;
                const dailyCosts = dailyFuelCost + otherCosts;
                const dailyProfit = earnedAmount - dailyCosts;
                
                const weeklyProfit = dailyProfit * workDaysWeek;
                const monthlyProfit = dailyProfit * workDaysMonth;
                
                // Обновляем результаты на странице
                todayAmountElement.textContent = formatNumberWithComma(earnedAmount.toFixed(2)) + ' ₽';
                workTimeElement.textContent = `${startTime} - ${endTime}`;
                ordersCountDisplayElement.textContent = `${ordersCount} заказ${ordersCount !== 1 ? (ordersCount % 10 >= 2 && ordersCount % 10 <= 4 && (ordersCount % 100 < 10 || ordersCount % 100 >= 20) ? 'а' : 'ов') : ''}`;
                
                dailyOrdersElement.textContent = formatNumberWithComma(ordersCount.toFixed(2));
                dailyIncomeElement.textContent = formatNumberWithComma(earnedAmount.toFixed(2)) + ' руб.';
                dailyCostsElement.textContent = formatNumberWithComma(dailyCosts.toFixed(2)) + ' руб.';
                dailyProfitElement.textContent = formatNumberWithComma(dailyProfit.toFixed(2)) + ' руб.';
                weeklyProfitElement.textContent = formatNumberWithComma(weeklyProfit.toFixed(2)) + ' руб.';
                monthlyProfitElement.textContent = formatNumberWithComma(monthlyProfit.toFixed(2)) + ' руб.';
                
                // Сохраняем данные
                saveData();
            }
            
            // Показать кастомную клавиатуру
            function showKeyboard() {
                customKeyboard.classList.add('keyboard-visible');
            }
            
            // Скрыть кастомную клавиатуру
            function hideKeyboard() {
                customKeyboard.classList.remove('keyboard-visible');
                activeInput = null;
            }
            
            // Обработчики событий для полей ввода
            const allInputs = document.querySelectorAll('input[type="text"]');
            allInputs.forEach(input => {
                input.addEventListener('focus', function() {
                    activeInput = this;
                    showKeyboard();
                });
                
                // Отключаем стандартную клавиатуру на touch-устройствах
                input.addEventListener('click', function(e) {
                    e.preventDefault();
                    this.focus();
                });
            });
            
            // Обработчики для времени
            startTimeInput.addEventListener('change', calculate);
            endTimeInput.addEventListener('change', calculate);
            
            // Обработчики для кнопок кастомной клавиатуры
            document.querySelectorAll('.keyboard-key').forEach(key => {
                key.addEventListener('click', function() {
                    if (!activeInput) return;
                    
                    const value = this.getAttribute('data-value');
                    const action = this.getAttribute('data-action');
                    
                    if (action === 'backspace') {
                        // Удаление последнего символа
                        activeInput.value = activeInput.value.slice(0, -1);
                    } else if (action === 'clear') {
                        // Очистка поля
                        activeInput.value = '';
                    } else if (action === 'hide') {
                        // Скрытие клавиатуры
                        hideKeyboard();
                        return;
                    } else if (value) {
                        // Добавление значения
                        // Проверка для десятичных чисел
                        if (value === ',' && activeInput.value.includes(',')) {
                            return; // Не добавляем вторую запятую
                        }
                        
                        // Если поле пустое и добавляем запятую, то добавляем "0," вместо просто ","
                        if (value === ',' && activeInput.value === '') {
                            activeInput.value = '0,';
                        } else {
                            activeInput.value += value;
                        }
                    }
                    
                    // Запускаем расчет после изменения значения
                    calculate();
                });
            });
            
            // Скрытие клавиатуры при клике вне поля ввода
            document.addEventListener('click', function(e) {
                if (!e.target.closest('input') && !e.target.closest('.custom-keyboard')) {
                    hideKeyboard();
                }
            });
            
            // Обработчик события для кнопки сброса
            resetBtn.addEventListener('click', resetData);
            
            // Обработчик события для кнопки сохранения дня
            saveDayBtn.addEventListener('click', saveDay);
            
            // Автоматический расчет при изменении любого поля
            allInputs.forEach(input => {
                input.addEventListener('input', calculate);
            });
            
            // Переключение темы
            function toggleTheme() {
                const isDark = document.body.classList.toggle('dark-theme');
                document.body.classList.toggle('light-theme', !isDark);
                themeToggle.classList.toggle('active', isDark);
                
                // Обновляем иконку в зависимости от темы
                const icon = themeToggle.querySelector('.theme-toggle-icon');
                if (isDark) {
                    icon.className = 'fas fa-moon theme-toggle-icon';
                    localStorage.setItem('theme', 'dark');
                } else {
                    icon.className = 'fas fa-sun theme-toggle-icon';
                    localStorage.setItem('theme', 'light');
                }
            }
            
            themeToggle.addEventListener('click', toggleTheme);
            
            // Обработка касания для мобильных устройств
            themeToggle.addEventListener('touchstart', function(e) {
                e.preventDefault();
                toggleTheme();
            }, { passive: false });
            
            // Проверка сохраненной темы
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.body.classList.remove('light-theme');
                themeToggle.classList.add('active');
                
                // Обновляем иконку
                const icon = themeToggle.querySelector('.theme-toggle-icon');
                icon.className = 'fas fa-moon theme-toggle-icon';
            }
            
            // Установка текущего времени по умолчанию
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            endTimeInput.value = `${hours}:${minutes}`;
            
            // Загрузка сохраненных данных
            loadData();
            loadHistory();
            
            // Первоначальный расчет
            calculate();
        });
    </script>
</body>
</html>
